##################################
# Grafana Configuration File     #
##################################

[auth.generic_oauth]
enabled         = true
name            = FusionAuth
allow_sign_up   = true 
auto_login      = false

auto_assign_org_role = Editor

# Enable user sync for OAuth login to work
sync_users      = true
skip_org_role_sync = false
empty_scopes    = false

# Allow OAuth to assign users to organizations
auto_assign_org = true

# Additional settings to handle user sync issues
allow_assign_grafana_admin = false
role_attribute_strict = false

client_id       = 30281d0c-b599-45e3-98d1-46ed603e0f37
client_secret   = GbydAgyvvTMkeuCXu4GfLjfrz2MhF8r_ahcB2iICZrE

scopes          = openid profile email

auth_url           = https://fusionauthfusionauth-applatest-production-2c11.up.railway.app/oauth2/authorize?prompt=login
token_url          = https://fusionauthfusionauth-applatest-production-2c11.up.railway.app/oauth2/token
api_url            = https://fusionauthfusionauth-applatest-production-2c11.up.railway.app/oauth2/userinfo

use_pkce             = true
allow_id_token       = true

# Use FusionAuth ID for user lookup and external ID mapping
id_token_attribute_name = sub

login_attribute_path = $.sub
email_attribute_path = $.email
name_attribute_path  = $.email   # Use email as name for readability
groups_attribute_path   = $.roles[*]

# Map external user ID to FusionAuth ID for proper user correlation
external_user_info_attribute_name = sub
external_user_info_attribute_path = $.sub

role_attribute_path     = contains($.roles, 'grafana-admin') && 'Admin' \
                        || contains($.roles, 'grafana-editor') && 'Editor' \
                        || 'Viewer'

[server]
root_url = http://localhost:4000

# Enable user creation for OAuth compatibility
[users]
allow_sign_up = true
allow_org_create = false
auto_assign_org = true
auto_assign_org_id = 1
auto_assign_org_role = Editor

# Disable verification requirements that might cause issues
verify_email_enabled = false
login_hint = email or username

[auth]
# Allow OAuth auto-login but don't disable login form completely
disable_login_form = false
oauth_auto_login = false

[log]
mode = file console
level = debug
logs = /var/log/grafana