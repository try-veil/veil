{
    order veil_handler before reverse_proxy
    admin 0.0.0.0:2019
    auto_https off
    debug
}

# Management/Onboarding API (port 2020)
:2020 {
    log {
        output stderr
        format console
        level DEBUG
    }
    handle /veil/api/* {
        veil_handler ./veil.db X-Subscription-Key
    }
}

# Public API Gateway (port 2021)
:2021 {
    log {
        output stderr
        format console
        level DEBUG
    }
    
    # Handle CORS preflight requests
    @options method OPTIONS
    handle @options {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, PATCH, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization, X-Subscription-Key, X-Requested-With"
        header Access-Control-Allow-Credentials "true"
        respond "" 200
    }
    
    # Add CORS headers to all responses
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Credentials "true"
}